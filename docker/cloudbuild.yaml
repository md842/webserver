steps:
  # Pull cached base image (runs in parallel with steps 2-4)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker pull gcr.io/$PROJECT_ID/webserver:base || exit 0']
    waitFor: ['-'] # Run immediately
    id: 'Pull cached base image'

  # Pull cached production binary (runs in parallel with steps 1, 3, 4)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker pull gcr.io/$PROJECT_ID/webserver:build || exit 0']
    waitFor: ['-'] # Run immediately
    id: 'Pull cached production binary'

  # Pull production frontend tarball from Google Cloud Storage (runs in parallel with steps 1, 2, 4)
  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['cp', 'gs://${PROJECT_ID}_cloudbuild/build.tar.gz', '.']
    waitFor: ['-'] # Run immediately
    id: 'Pull production frontend tarball'

  # Prepare production frontend directory (runs in parallel with steps 1-3)
  - name: 'ubuntu'
    args: ['mkdir', 'frontend']
    waitFor: ['-'] # Run immediately
    id: 'Prepare production frontend directory'

  # Extract production frontend tarball
  - name: 'ubuntu'
    args: ['tar', '-xzf', 'build.tar.gz', '-C', 'frontend']
    waitFor: ['Pull production frontend tarball', 'Prepare production frontend directory']
    id: 'Extract production frontend tarball'

  # Build base image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-f', 'docker/base.Dockerfile',
      '-t', 'webserver:base',
      '-t', 'gcr.io/$PROJECT_ID/webserver:base',
      '--cache-from', 'gcr.io/$PROJECT_ID/webserver:base',
      '.'
    ]
    waitFor: ['Pull cached base image']
    id: 'Build base image'

  # Build production binary (runs in parallel with unit testing)
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-f', 'docker/build.Dockerfile',
      '-t', 'webserver:build',
      '-t', 'gcr.io/$PROJECT_ID/webserver:build',
      '--cache-from', 'gcr.io/$PROJECT_ID/webserver:build',
      '.'
    ]
    # Relies on base image if not using cache
    waitFor: ['Pull cached production binary', 'Build base image']
    id: 'Build production binary'

  # Unit testing and coverage report (runs in parallel with production binary)
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-f', 'docker/test_coverage.Dockerfile',
      '.'
    ]
    # Relies on base image and extracted frontend (for integration tests)
    waitFor: ['Build base image', 'Extract production frontend tarball']
    id: 'Unit testing and coverage report'

  # Build deployment image (runs in parallel with unit tests)
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-f', 'docker/deploy.Dockerfile',
      '-t', 'gcr.io/$PROJECT_ID/webserver:latest',
      '.'
    ]
    # Relies on production binary and extracted frontend
    waitFor: ['Build production binary', 'Extract production frontend tarball']
    id: 'Build deployment image'

# Push images to Google Artifact Registry
images: [
  'gcr.io/$PROJECT_ID/webserver:base', # Cache base image
  'gcr.io/$PROJECT_ID/webserver:build', # Cache production binary
  'gcr.io/$PROJECT_ID/webserver:latest' # Deployment container
]

# Cloud build options
serviceAccount: '$SERVICE_ACCOUNT_EMAIL'
options:
  logging: CLOUD_LOGGING_ONLY