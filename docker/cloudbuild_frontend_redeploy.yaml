# Used when a push to frontend repository invokes backend webhook trigger.
# Because the backend is unchanged, skip backend binary build/test and simply
# update the production frontend in webserver:latest.

steps:
  # 1. Pull latest production image (runs in parallel with steps 2-4)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker pull gcr.io/$PROJECT_ID/webserver:latest || exit 0']
    waitFor: ['-'] # Run immediately
    id: 'Pull latest production image'

  # 2. Pull production frontend tarball from Google Cloud Storage (runs in parallel with steps 1, 3)
  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['cp', 'gs://${PROJECT_ID}_cloudbuild/build.tar.gz', '.']
    waitFor: ['-'] # Run immediately
    id: 'Pull production frontend tarball'

  # 3. Prepare production frontend directory (runs in parallel with steps 1, 2)
  - name: 'alpine'
    args: ['mkdir', 'frontend']
    waitFor: ['-'] # Run immediately
    id: 'Prepare production frontend directory'

  # 4. Extract production frontend tarball (relies on step 2, 3)
  - name: 'alpine'
    args: ['tar', '-xzf', 'build.tar.gz', '-C', 'frontend']
    waitFor: ['Pull production frontend tarball', 'Prepare production frontend directory']
    id: 'Extract production frontend tarball'

  # 5. Re-tag latest production image for use in frontend_redeploy.Dockerfile (relies on step 1)
  - name: 'gcr.io/cloud-builders/docker'
    args: ['tag', 'gcr.io/$PROJECT_ID/webserver:latest', 'webserver:latest']
    waitFor: ['Pull latest production image']
    id: 'Re-tag latest production image'

  # 6. Prepare deployment image (uses extracted frontend from step 4 and production build image from step 5)
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '-f', 'docker/frontend_redeploy.Dockerfile',
      '-t', 'gcr.io/$PROJECT_ID/webserver:latest',
      '.'
    ]
    waitFor: ['Re-tag latest production image', 'Extract production frontend tarball']
    id: 'Prepare deployment image'

# Push images to Google Artifact Registry
images: [
  'gcr.io/$PROJECT_ID/webserver:latest' # Deployment container
]

# Cloud build options
serviceAccount: '$SERVICE_ACCOUNT_EMAIL'
options:
  logging: CLOUD_LOGGING_ONLY